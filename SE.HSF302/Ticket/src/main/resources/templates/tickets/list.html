<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết vé</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" th:href="@{/css/main.css}">
</head>
<body>
<div class="container mt-4">
    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show">
        <span th:text="${successMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show">
        <span th:text="${errorMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h3>Vé #<span th:text="${ticket.code}"></span></h3>
                <span class="badge rounded-pill fs-6"
                      th:classappend="${ticket.status == T(sum25.se196853.ticket.model.Ticket.TicketStatus).paid || ticket.status == T(sum25.se196853.ticket.model.Ticket.TicketStatus).checked_in ? 'bg-success' :
                                          (ticket.status == T(sum25.se196853.ticket.model.Ticket.TicketStatus).booked ? 'bg-warning' : 'bg-danger')}"
                      th:text="${ticket.status}">
                    </span>
            </div>
        </div>
        <div class="card-body">
            <div class="row mb-4">
                <div class="col-md-6">
                    <h5>Thông tin hành khách</h5>
                    <p><strong>Họ và tên:</strong> <span th:text="${ticket.passengerName}"></span></p>
                    <p><strong>Số điện thoại:</strong> <span th:text="${ticket.passengerPhone}"></span></p>
                    <p><strong>Số CMND/CCCD:</strong> <span th:text="${ticket.passengerIdCard}"></span></p>
                </div>
                <div class="col-md-6">
                    <h5>Thông tin chuyến đi</h5>
                    <p><strong>Mã tàu:</strong> <span th:text="${ticket.trip.trainCode}"></span></p>
                    <p><strong>Ngày đi:</strong> <span th:text="${#temporals.format(ticket.trip.tripDate, 'dd/MM/yyyy')}"></span></p>
                    <p><strong>Giờ khởi hành:</strong> <span th:text="${ticket.trip.departureTime}"></span></p>
                    <p><strong>Giờ đến:</strong> <span th:text="${ticket.trip.arrivalTime}"></span></p>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <h5>Thông tin vé</h5>
                    <p><strong>Toa:</strong> <span th:text="${ticket.seat.carriageNumber}"></span></p>
                    <p><strong>Ghế:</strong> <span th:text="${ticket.seat.seatNumber}"></span></p>
                    <p><strong>Loại ghế:</strong> <span th:text="${ticket.seat.seatType}"></span></p>
                </div>
                <div class="col-md-6">
                    <h5>Lộ trình</h5>
                    <p><strong>Ga đi:</strong> <span th:text="${ticket.fromStation.name}"></span></p>
                    <p><strong>Ga đến:</strong> <span th:text="${ticket.toStation.name}"></span></p>
                    <p><strong>Khoảng cách:</strong> <span th:text="${ticket.distanceKm + ' km'}"></span></p>
                    <p><strong>Giá vé:</strong> <span th:text="${ticket.totalPrice}"></span></p>
                </div>
            </div>

            <div class="text-center mb-3">
                <div th:if="${ticket.status == T(sum25.se196853.ticket.model.Ticket.TicketStatus).paid}">
                    <a th:href="@{/tickets/check-in/{id}(id=${ticket.id})}" class="btn btn-success">Check-in</a>
                </div>
                <div th:if="${ticket.status == T(sum25.se196853.ticket.model.Ticket.TicketStatus).checked_in}">
                    <span class="badge bg-success fs-5">Đã check-in lúc <span th:text="${#temporals.format(ticket.checkedInAt, 'dd/MM/yyyy HH:mm')}"></span></span>
                </div>
            </div>

            <div class="text-center">
                <!-- SỬA LỖI: Cần đảm bảo ${ticket.code} được truyền đúng vào URL của QR code -->
                <img th:src="@{'https://chart.googleapis.com/chart?cht=qr&chl=TICKET_CODE:' + ${ticket.code} + '&chs=200x200'}"
                     alt="QR Code" class="img-fluid">
            </div>
        </div>
    </div>

    <div class="mt-3">
        <a th:href="@{/tickets}" class="btn btn-secondary">Quay lại danh sách</a>
        <!-- SỬA LỖI: Đảm bảo ${ticket.booking} không bị null. Thêm kiểm tra nếu cần. -->
        <a th:if="${ticket.booking != null}" th:href="@{/bookings/details/{id}(id=${ticket.booking.id})}" class="btn btn-info">Xem đặt vé</a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
